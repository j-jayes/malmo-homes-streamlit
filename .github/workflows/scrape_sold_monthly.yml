name: Scrape Sold Properties (Monthly)

on:
  schedule:
    # First day of every month at 3 AM UTC
    - cron: '0 3 1 * *'
  workflow_dispatch:
    inputs:
      month:
        description: 'Month to scrape (YYYY-MM)'
        required: false
        default: ''
      test_mode:
        description: 'Test mode (only 2 pages)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  scrape-sold-properties:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Create virtual environment and install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install playwright
      
      - name: Install Playwright and browsers
        run: |
          source .venv/bin/activate
          playwright install chromium --with-deps
      
      - name: Setup virtual display (Xvfb)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          # Start Xvfb
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          sleep 3
          echo "DISPLAY=:99" >> $GITHUB_ENV
      
      - name: Determine month to scrape
        id: month
        run: |
          if [ -n "${{ github.event.inputs.month }}" ]; then
            MONTH="${{ github.event.inputs.month }}"
          else
            # Get last month (YYYY-MM)
            MONTH=$(date -d "last month" +%Y-%m)
          fi
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          echo "Scraping month: $MONTH"
      
      - name: Run scraper
        run: |
          source .venv/bin/activate
          
          # Build command
          CMD="python src/scrapers/sold_properties_scraper.py --month ${{ steps.month.outputs.month }} --headless"
          
          # Add test flag if needed
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            CMD="$CMD --test"
          fi
          
          # Run the scraper
          echo "Running: $CMD"
          $CMD
        env:
          DISPLAY: ${{ env.DISPLAY }}
      
      - name: Check output file
        run: |
          MONTH=${{ steps.month.outputs.month }}
          FILE="data/raw/sold_properties_${MONTH//-/}.csv"
          
          if [ -f "$FILE" ]; then
            echo "âœ… Output file created: $FILE"
            LINES=$(wc -l < "$FILE")
            echo "ðŸ“Š Lines in file: $LINES"
            
            # Show first few lines
            echo "Preview:"
            head -n 5 "$FILE"
          else
            echo "âŒ Output file not found: $FILE"
            exit 1
          fi
      
      - name: Commit and push data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "data: add sold properties for ${{ steps.month.outputs.month }}"
          file_pattern: 'data/raw/sold_properties_*.csv data/.hemnet_session.json'
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
      
      - name: Upload scraping logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sold-scraping-logs-${{ steps.month.outputs.month }}
          path: |
            data/raw/sold_properties_*.csv
          retention-days: 30
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const month = '${{ steps.month.outputs.month }}';
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Sold properties scraping failed for ${month}`,
              body: `The monthly sold properties scraping workflow failed for ${month}.\n\nCheck the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n\n**Next steps:**\n- Review the logs\n- Check if Cloudflare blocking occurred\n- Manually trigger the workflow with test mode\n- Consider running locally if the issue persists`,
              labels: ['automation', 'scraping', 'sold-properties', 'bug']
            })
